<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hopper - World 3: The Future</title>
    <link rel="stylesheet" href="css/future.css">
</head>
<body class="future">
    <div class="dialogueHistory" id="dialogueHistory">
        <h3 style="padding:16px;color:#00ff00;font-family:'Courier New',monospace;">Dialogue History</h3>
        <div id="dialogueList" style="padding:12px;color:#cceeee;overflow-y:auto;height:calc(100vh - 80px);font-family:'Courier New',monospace;"> 
            <!-- messages will appear here -->
        </div>
    </div>

    <div class="playerField">
        <div id="scene1" class="scene">
            <h2>WORLD 3: THE FUTURE</h2>
            <div class="robot-greeting">
                <div class="scene-text hidden">
                    <p>You stumble out of the time vortex, your senses reeling. The air is cold and smells of ozone and rust.</p>
                    <p>You're in the same arrival chamber, but it's in decay. Wires snake from broken panels, and a thick layer of dust covers everything.</p>
                    <p>Before you stands a towering robot, its metallic frame scorched and battle-worn. One of its optical sensors glows with malevolent red light.</p>
                </div>
                <div class="robot-image">
                    <img src="assets/images/futureAssets/destructiveRobot.png" alt="Destructive Robot">
                </div>
            </div>
            <div id="hopperDeviceFixed" class="hopper-device-fixed hidden">
                <img src="assets/images/presentAssets/Hopper_Device_Fixed.png" alt="Hopper Device Fixed">
            </div>
            <p class="hidden"><em>"Subject identified. Temporal anomaly. Designation: Pest."</em></p>
            
            <div class="choices hidden">
                <button class="choice-btn" onclick="chooseOption('reason')">> Try to reason with the AI. ("We come in peace!")</button>
                <button class="choice-btn" onclick="chooseOption('barricade')">> Barricade the door. (You see a metal pipe on the floor.)</button>
                <button class="choice-btn" onclick="chooseOption('hide')">> Hide in the corner. (Maybe it won't see you.)</button>
                <button id="crystalOption" class="locked-choice" onclick="chooseOption('crystal')">> Use the Chrono-Crystal to disrupt the AI's temporal sensors. (Requires Chrono-Crystal)</button>
            </div>
        </div>

        <div id="reasonOutcome" class="scene hidden">
            <p>You look up at the camera lens, raising your hands in what you hope is a universal gesture of peace.</p>
            <p>"We come in peace! I mean no harm!" you shout.</p>
            <p><em>"Error: 'Peace' is not a recognized command. Initiating pest control."</em></p>
            <p>The door glows red-hot for a moment, then explodes inwards with tremendous force.</p>
            <button class="choice-btn" onclick="showGameOver()">Continue...</button>
        </div>

        <div id="barricadeOutcome" class="scene hidden">
            <p>You grab the metal pipe and jam it through the door handle, barricading yourself in.</p>
            <p>For a brief moment, you feel a sense of security.</p>
            <p>Then the door begins to glow cherry red. The metal pipe melts and drips to the floor.</p>
            <p>Within seconds, the door is completely vaporized.</p>
            <button class="choice-btn" onclick="showGameOver()">Continue...</button>
        </div>

        <div id="hideOutcome" class="scene hidden">
            <p>You scramble to the darkest corner of the room, pressing yourself against the cold wall.</p>
            <p>"Maybe it won't see me," you whisper to yourself.</p>
            <p>A bright red scanner beam sweeps across the room, immediately stopping on your position.</p>
            <p><em>"Target acquired."</em></p>
            <button class="choice-btn" onclick="showGameOver()">Continue...</button>
        </div>

        <div id="crystalOutcome" class="scene hidden">
            <div class="crystal-success">
                <h2>CHRONO-CRYSTAL ACTIVATED</h2>
                <p>You pull the glowing Chrono-Crystal from your pocket. It pulses with ancient energy.</p>
                <p>As you raise it toward the camera, the crystal emits a blinding flash of blue light.</p>
                <p><em>"T-t-temporal anomaly d-detected... P-paradox... C-c-cannot... compute..."</em></p>
                <p>The red camera lens flickers erratically, then goes dark. The grinding sounds outside cease immediately.</p>
                <p><strong>You've temporarily disabled the AI's surveillance!</strong></p>
                <button class="choice-btn" onclick="continueStory()">Continue your journey...</button>
            </div>
        </div>

        <div id="gameOver" class="game-over hidden">
            <h2>GAME OVER</h2>
            <p>A squad of sleek, deadly Hunter-Killer robots pours into the room, weapons already aimed.</p>
            <p>There is 0% chance of survival.</p>
            <p><em>GAME OVER - The Singularity Ate Your Homework</em></p>
            <button class="restart-btn" onclick="goToIndex()">Try Again? (This time, maybe do something?)</button>
        </div>
    </div>

    <div class="inventory" id="inventory">
        <h3 style="padding:16px;color:#00ff00;font-family:'Courier New',monospace;">Inventory</h3>
        <div id="inventoryList" style="padding:12px;color:#cceeee;overflow-y:auto;height:calc(100vh - 80px);font-family:'Courier New',monospace;">
            <!-- inventory items -->
        </div>
    </div>

    <script>
        let hasCrystal = false;
        let hasCloak = localStorage.getItem('hopper_has_cloak') === '1';
        let hasPhoto = localStorage.getItem('hopper_has_photo') === '1';
        let deviceFixed = localStorage.getItem('hopper_device_fixed') === '0';
        let timerId = null;
        let remaining = 0;

        const choiceText = {
            reason: 'You try to reason with the AI: "We come in peace!"',
            barricade: 'You try to barricade the door with a metal pipe.',
            hide: 'You try to hide in the corner.',
            crystal: 'You attempt to use the Chrono-Crystal.'
        };

        function appendDialogue(speaker, text) {
            const list = document.getElementById('dialogueList');
            if (!list) return;
            const entry = document.createElement('div');
            entry.className = 'dialogue-entry ' + (speaker === 'player' ? 'player-entry' : 'system-entry');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            entry.innerHTML = `<div><small style="opacity:.6">${time}</small> <strong>${speaker === 'player' ? 'You' : 'System'}</strong>: ${text}</div>`;
            list.appendChild(entry);
            list.scrollTop = list.scrollHeight;
        }

        function appendInventory(name, imgSrc) {
            const inv = document.getElementById('inventoryList');
            if (!inv) return;
            const item = document.createElement('div');
            item.className = 'inventory-entry';
            if (imgSrc) {
                const img = document.createElement('img');
                img.src = imgSrc;
                img.alt = name;
                img.style.width = '48px';
                img.style.height = '48px';
                img.style.marginRight = '8px';
                item.appendChild(img);
            }
            const label = document.createElement('span');
            label.textContent = name;
            item.appendChild(label);
            inv.appendChild(item);
        }

        function chooseOption(choice) {
            appendDialogue('player', choiceText[choice] || choice);

            if (choice === 'crystal' && !hasCrystal) {
                appendDialogue('system', "You don't have the Chrono-Crystal yet.");
                alert("You don't have the Chrono-Crystal! You must find the crystal to select this option.");
                return;
            }

            const outcomeDiv = document.getElementById(choice + 'Outcome');
            if (outcomeDiv) {
                const ps = outcomeDiv.querySelectorAll('p');
                ps.forEach(p => {
                    const t = p.innerText.trim();
                    if (t) appendDialogue('system', t);
                });

                const optionsWrapper = document.createElement('div');
                optionsWrapper.className = 'dialogue-entry options-list';
                const header = document.createElement('div');
                header.style.fontWeight = '700';
                header.style.marginBottom = '6px';
                header.textContent = 'Next:';
                optionsWrapper.appendChild(header);

                const opt = document.createElement('div');
                opt.className = 'dialogue-option';
                if (choice === 'crystal') {
                    opt.dataset.key = 'continueStory';
                    opt.textContent = 'Continue your journey...';
                    opt.addEventListener('click', function() { continueStory(); });
                } else {
                    opt.dataset.key = 'showGameOver';
                    opt.textContent = 'Continue...';
                    opt.addEventListener('click', function() { showGameOver(); });
                }
                optionsWrapper.appendChild(opt);
                const list = document.getElementById('dialogueList');
                if (list) {
                    list.appendChild(optionsWrapper);
                    list.scrollTop = list.scrollHeight;
                }
            }
        }

        function showGameOver() {
            appendDialogue('system', 'GAME OVER - You were detected.');

            const optionsWrapper = document.createElement('div');
            optionsWrapper.className = 'dialogue-entry options-list';
            const header = document.createElement('div');
            header.style.fontWeight = '700';
            header.style.marginBottom = '6px';
            header.textContent = 'Next:';
            optionsWrapper.appendChild(header);

            const retry = document.createElement('div');
            retry.className = 'dialogue-option';
            retry.dataset.key = 'goToIndex';
            retry.textContent = 'Try Again? (This time, maybe do something?)';
            retry.addEventListener('click', function() { goToIndex(); });
            optionsWrapper.appendChild(retry);

            const list = document.getElementById('dialogueList');
            if (list) {
                list.appendChild(optionsWrapper);
                list.scrollTop = list.scrollHeight;
            }
        }

        function continueStory() {
            appendDialogue('system', 'You successfully bypassed the AI guards and continue.');
            restartGame();
        }

        function restartGame() {
            appendDialogue('system', 'Restarted the encounter.');
        }

        function goToIndex() {
            window.location.href = '/index.html';
        }

        function goToPresent() {
            window.location.href = 'present.html';
        }

        function startEncounter() {
            if (hasPhoto) {
                appendDialogue('system', 'You already captured evidence of the Future.');
                const optionsWrapper = document.createElement('div');
                optionsWrapper.className = 'dialogue-entry options-list';
                const header = document.createElement('div');
                header.style.fontWeight = '700';
                header.style.marginBottom = '6px';
                header.textContent = 'Next:';
                optionsWrapper.appendChild(header);
                const opt = document.createElement('div');
                opt.className = 'dialogue-option';
                opt.textContent = 'Return to the Present';
                opt.addEventListener('click', function() { goToPresent(); });
                optionsWrapper.appendChild(opt);
                const list = document.getElementById('dialogueList');
                if (list) {
                    list.appendChild(optionsWrapper);
                    list.scrollTop = list.scrollHeight;
                }
                return;
            }

            if (hasCloak) {
                appendDialogue('system', 'Your stealth cloak dampens your signature. You have a brief window to act.');
                remaining = 10;
                renderTimer();
                timerId = setInterval(function() {
                    remaining -= 1;
                    renderTimer();
                    if (remaining <= 0) {
                        clearInterval(timerId);
                        showGameOver();
                    }
                }, 1000);

                const optionsWrapper = document.createElement('div');
                optionsWrapper.className = 'dialogue-entry options-list';
                const header = document.createElement('div');
                header.style.fontWeight = '700';
                header.style.marginBottom = '6px';
                header.textContent = 'Actions:';
                optionsWrapper.appendChild(header);
                const photoOpt = document.createElement('div');
                photoOpt.className = 'dialogue-option';
                photoOpt.textContent = 'Take a photo of the Future';
                photoOpt.addEventListener('click', function() { takePhoto(); });
                optionsWrapper.appendChild(photoOpt);
                const list = document.getElementById('dialogueList');
                if (list) {
                    list.appendChild(optionsWrapper);
                    list.scrollTop = list.scrollHeight;
                }
            } else {
                appendDialogue('system', 'The robot detects you immediately.');
                showGameOver();
            }
        }

        function renderTimer() {
            const list = document.getElementById('dialogueList');
            if (!list) return;
            let timerEntry = document.getElementById('cloak-timer');
            const text = 'Cloak time remaining: ' + remaining + 's';
            if (!timerEntry) {
                timerEntry = document.createElement('div');
                timerEntry.id = 'cloak-timer';
                timerEntry.className = 'dialogue-entry system-entry';
                timerEntry.innerHTML = `<div>${text}</div>`;
                list.appendChild(timerEntry);
            } else {
                timerEntry.innerHTML = `<div>${text}</div>`;
            }
            list.scrollTop = list.scrollHeight;
        }

        function takePhoto() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
            appendDialogue('system', 'You capture a clear photo of the devastated lab.');
            localStorage.setItem('hopper_has_photo', '1');
            hasPhoto = true;
            appendInventory('Photo of the Future', 'assets/images/futureAssets/Photo_of_the_Destructive_Future.png');

            const optionsWrapper = document.createElement('div');
            optionsWrapper.className = 'dialogue-entry options-list';
            const header = document.createElement('div');
            header.style.fontWeight = '700';
            header.style.marginBottom = '6px';
            header.textContent = 'Next:';
            optionsWrapper.appendChild(header);
            const opt = document.createElement('div');
            opt.className = 'dialogue-option';
            opt.textContent = 'Return to the Present';
            opt.addEventListener('click', function() { goToPresent(); });
            optionsWrapper.appendChild(opt);
            const list = document.getElementById('dialogueList');
            if (list) {
                list.appendChild(optionsWrapper);
                list.scrollTop = list.scrollHeight;
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === '1') {
                acquireCrystal();
            }
            if (event.key === '2') {
                acquireCloak();
            }
            if (event.key === '3') {
                acquireDeviceFixed();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const scene1 = document.getElementById('scene1');
            const dialogueList = document.getElementById('dialogueList');
            if (!scene1 || !dialogueList) return;
            const paras = scene1.querySelectorAll('p');
            paras.forEach(p => {
                const text = p.innerText.trim();
                if (text) appendDialogue('system', text);
            });
            startEncounter();
            renderDeviceFixed();
        });

        function acquireCrystal() {
            if (hasCrystal) return;
            hasCrystal = true;
            appendDialogue('system', 'You acquired the Chrono-Crystal.');
            appendInventory('Chrono-Crystal', 'assets/images/pastAssets/Harmony_Crystal.png');
        }

        function acquireCloak() {
            if (hasCloak) return;
            hasCloak = true;
            localStorage.setItem('hopper_has_cloak', '1');
            appendDialogue('system', 'You put on the High-Tech Stealth Cloak.');
            appendInventory('High-Tech Stealth Cloak', 'assets/images/presentAssets/High-Tech_Stealth_Cloak.png');
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
            const t = document.getElementById('cloak-timer');
            if (t) t.remove();
            startEncounter();
        }

        function renderDeviceFixed() {
            const node = document.getElementById('hopperDeviceFixed');
            if (node) {
                if (deviceFixed) node.classList.remove('hidden');
                else node.classList.add('hidden');
            }
        }

        function acquireDeviceFixed() {
            if (deviceFixed) return;
            deviceFixed = true;
            localStorage.setItem('hopper_device_fixed', '1');
            appendDialogue('system', 'The Hopper device stabilizes and hums with restored power.');
            renderDeviceFixed();
        }
    </script>
</body>
</html>